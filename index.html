<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم حضور و غیاب</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #4a6491;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
        }
        
        body {
            font-family: 'Vazir', 'Segoe UI', Tahoma, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        /* استایل بخش ورود */
        #loginSection {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .login-body {
            padding: 25px;
        }
        
        .form-control {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }
        
        .btn-login {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px;
            border-radius: 8px;
            border: none;
            width: 100%;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .btn-login:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
        }
        
        .credentials {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-right: 4px solid var(--secondary-color);
        }
        
        .credential-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .credential-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .login-alert {
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            display: none;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .login-footer {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* استایل بخش اصلی */
        #mainApp {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .furnace-section {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        
        .furnace-1 {
            border-top: 5px solid var(--info-color);
        }
        
        .furnace-2 {
            border-top: 5px solid var(--danger-color);
        }
        
        .furnace-title {
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: var(--primary-color);
        }
        
        .position-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .position-item:hover {
            background-color: #f8f9fa;
        }
        
        .btn-action {
            margin-left: 5px;
        }
        
        .badge-present {
            background-color: var(--success-color);
        }
        
        .badge-absent {
            background-color: var(--danger-color);
        }
        
        .badge-overtime {
            background-color: var(--warning-color);
        }
        
        .badge-exchange {
            background-color: var(--info-color);
        }
        
        .present-personnel {
            background-color: #e9f7ef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--success-color);
        }
        
        .footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .shift-selector {
            margin-bottom: 20px;
        }
        
        .shift-btn {
            margin-left: 5px;
        }
        
        .current-date {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        
        .personnel-list {
            margin-top: 10px;
        }
        
        .personnel-item {
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .personnel-info {
            flex-grow: 1;
        }
        
        .personnel-actions {
            display: flex;
            gap: 5px;
        }
        
        .add-personnel-btn {
            margin-top: 10px;
        }
        
        .admin-panel {
            background-color: #fff3cd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
            display: none;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .personnel-table {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .personnel-table th {
            background-color: #f8f9fa;
        }
        
        .status-present { background-color: #d4edda; color: #155724; }
        .status-absent { background-color: #f8d7da; color: #721c24; }
        .status-overtime { background-color: #fff3cd; color: #856404; }
        .status-exchange { background-color: #d1ecf1; color: #0c5460; }
        
        .personnel-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 10px;
        }
        
        .modal-content {
            border-radius: 10px;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-top-right-radius: 10px;
            border-top-left-radius: 10px;
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .shift-btn {
                margin-bottom: 5px;
                width: 100%;
            }
            
            .btn-group {
                width: 100%;
            }
            
            .footer-actions {
                flex-wrap: wrap;
            }
            
            .footer-actions .btn {
                margin-bottom: 5px;
                flex: 1;
                min-width: 120px;
            }
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .footer-actions {
                display: none !important;
            }
            #loginSection {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- بخش ورود -->
    <div id="loginSection">
        <div class="login-container">
            <div class="login-header">
                <h3><i class="fas fa-calendar-check me-2"></i>سیستم حضور و غیاب</h3>
                <p class="mb-0">لطفاً وارد سیستم شوید</p>
            </div>
            
            <div class="login-body">
                <div class="login-alert alert-danger" id="loginErrorAlert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="loginErrorMessage"></span>
                </div>
                
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">نام کاربری</label>
                        <input type="text" class="form-control" id="username" placeholder="نام کاربری خود را وارد کنید" autocomplete="username">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">رمز عبور</label>
                        <input type="password" class="form-control" id="password" placeholder="رمز عبور خود را وارد کنید" autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-login pulse">
                        <i class="fas fa-sign-in-alt me-2"></i>ورود به سیستم
                    </button>
                </form>
                
                <div class="credentials">
                    <h6><i class="fas fa-key me-2"></i>اطلاعات ورود:</h6>
                    <div class="credential-item">
                        <span>کاربر عادی:</span>
                        <span>user / user123</span>
                    </div>
                    <div class="credential-item">
                        <span>مدیر سیستم:</span>
                        <span>admin / admin123</span>
                    </div>
                </div>
            </div>
            
            <div class="login-footer">
                <p class="mb-0">سیستم حضور و غیاب پرسنل | نسخه ۱.۰</p>
            </div>
        </div>
    </div>

    <!-- بخش اصلی برنامه -->
    <div id="mainApp">
        <div class="container">
            <!-- هدر -->
            <div class="header text-center">
                <h1><i class="fas fa-calendar-check me-2"></i>سیستم حضور و غیاب</h1>
                <div class="current-date">
                    امروز: <span id="current-date"></span>
                </div>
                <div class="user-info">
                    <span id="userInfo" class="badge bg-info"></span>
                    <button class="btn btn-sm btn-outline-light ms-2" id="logoutBtn">
                        <i class="fas fa-sign-out-alt me-1"></i>خروج
                    </button>
                </div>
            </div>

            <!-- پنل مدیریت پرسنل (فقط برای ادمین) -->
            <div class="admin-panel" id="adminPanel">
                <h4><i class="fas fa-users-cog me-2"></i>پنل مدیریت پرسنل</h4>
                <div class="search-box">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="جستجو بر اساس نام یا شماره پرسنلی..." id="personnelSearch">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button class="btn btn-success mb-3" id="addNewPersonnelBtn">
                    <i class="fas fa-user-plus me-1"></i>افزودن پرسنل جدید
                </button>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover personnel-table">
                        <thead>
                            <tr>
                                <th>نام و نام خانوادگی</th>
                                <th>شماره پرسنلی</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="personnelTableBody">
                            <!-- لیست پرسنل -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- انتخاب شیفت -->
            <div class="shift-selector text-center">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary shift-btn active" data-shift="morning">
                        <i class="fas fa-sun me-1"></i>شیفت صبح (۶-۱۴)
                    </button>
                    <button type="button" class="btn btn-outline-primary shift-btn" data-shift="evening">
                        <i class="fas fa-cloud-sun me-1"></i>شیفت بعدازظهر (۱۴-۲۲)
                    </button>
                    <button type="button" class="btn btn-outline-primary shift-btn" data-shift="night">
                        <i class="fas fa-moon me-1"></i>شیفت شب (۲۲-۶)
                    </button>
                </div>
            </div>

            <!-- پرسنل حاضر -->
            <div class="present-personnel">
                <h5><i class="fas fa-users me-2"></i>پرسنل حاضر در شیفت</h5>
                <div id="present-personnel-list" class="row">
                    <!-- لیست پرسنل حاضر -->
                </div>
            </div>

            <!-- کوره شماره ۱ -->
            <div class="furnace-section furnace-1">
                <h4 class="furnace-title"><i class="fas fa-industry me-2"></i>کوره شماره ۱</h4>
                <div class="list-group list-group-flush" id="furnace1Positions">
                    <!-- پست‌های کوره شماره ۱ -->
                </div>
            </div>

            <!-- کوره شماره ۲ -->
            <div class="furnace-section furnace-2">
                <h4 class="furnace-title"><i class="fas fa-industry me-2"></i>کوره شماره ۲</h4>
                <div class="list-group list-group-flush" id="furnace2Positions">
                    <!-- پست‌های کوره شماره ۲ -->
                </div>
            </div>
        </div>

        <!-- مودال ثبت اطلاعات -->
        <div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ثبت اطلاعات پرسنل</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="attendanceForm">
                            <input type="hidden" id="positionId">
                            <input type="hidden" id="furnaceType">
                            <input type="hidden" id="editIndex" value="-1">
                            <div class="mb-3">
                                <label for="employeeName" class="form-label">نام و نام خانوادگی</label>
                                <select class="form-select" id="employeeName" required>
                                    <option value="">انتخاب پرسنل</option>
                                    <!-- گزینه‌های پرسنل -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="employeeId" class="form-label">شماره پرسنلی</label>
                                <input type="text" class="form-control" id="employeeId" required readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">وضعیت حضور</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="status" id="statusPresent" value="present" checked>
                                    <label class="form-check-label" for="statusPresent">
                                        انجام وظیفه
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="status" id="statusLeave" value="leave">
                                    <label class="form-check-label" for="statusLeave">
                                        مرخصی
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="status" id="statusOvertime" value="overtime">
                                    <label class="form-check-label" for="statusOvertime">
                                        اضافه کار
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="status" id="statusExchange" value="exchange">
                                    <label class="form-check-label" for="statusExchange">
                                        تعویض
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3" id="exchangeSection" style="display: none;">
                                <label for="exchangeWith" class="form-label">تعویض با</label>
                                <input type="text" class="form-control" id="exchangeWith" placeholder="نام شخصی که تعویض شده است">
                            </div>
                            <div class="mb-3">
                                <label for="notes" class="form-label">توضیحات</label>
                                <textarea class="form-control" id="notes" rows="2"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                        <button type="button" class="btn btn-success" id="addAnotherBtn">
                            <i class="fas fa-plus me-1"></i>افزودن و ادامه
                        </button>
                        <button type="button" class="btn btn-primary" id="submitAttendance">ثبت و بستن</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- مودال مدیریت پرسنل -->
        <div class="modal fade" id="personnelModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="personnelModalTitle">افزودن پرسنل جدید</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="personnelForm">
                            <input type="hidden" id="personnelEditId" value="">
                            <div class="mb-3">
                                <label for="newEmployeeName" class="form-label">نام و نام خانوادگی</label>
                                <input type="text" class="form-control" id="newEmployeeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="newEmployeeId" class="form-label">شماره پرسنلی</label>
                                <input type="text" class="form-control" id="newEmployeeId" required pattern="\d+">
                                <div class="form-text">شماره پرسنلی باید فقط شامل عدد باشد</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                        <button type="button" class="btn btn-primary" id="savePersonnelBtn">ذخیره</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- footer actions -->
        <div class="footer-actions d-flex justify-content-center">
            <button class="btn btn-primary me-2" id="saveBtn">
                <i class="fas fa-save me-1"></i>ذخیره
            </button>
            <button class="btn btn-success me-2" id="reportBtn">
                <i class="fas fa-file-alt me-1"></i>گزارش
            </button>
            <button class="btn btn-info me-2 no-print" id="printBtn">
                <i class="fas fa-print me-1"></i>چاپ
            </button>
            <button class="btn btn-warning me-2 no-print" id="downloadBtn">
                <i class="fas fa-download me-1"></i>دانلود گزارش
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // داده‌های پست‌ها بر اساس کوره
        const positions = {
            furnace1: [
                {id: 0, name: "سرپرست شیفت"},
                {id: 1, name: "ذوبکار کوره یک"},
                {id: 2, name: "متصدی ماشین خط یک"},
                {id: 6, name: "متصدی لهر خط یک"},
                {id: 9, name: "متصدی برش و شیشه گیری خط یک"}
            ],
            furnace2: [
                {id: 0, name: "سرپرست شیفت"},
                {id: 3, name: "ذوبکار کوره دو"},
                {id: 4, name: "متصدی ماشین خط دو"},
                {id: 5, name: "متصدی ماشین خط سه"},
                {id: 7, name: "متصدی لهر خط دو"},
                {id: 8, name: "متصدی لهر خط سه"},
                {id: 10, name: "متصدی برش خط دو و سه"},
                {id: 11, name: "متصدی شیشه گیری خط دو و سه"}
            ]
        };

        const shifts = {
            morning: "صبح (۶-۱۴)",
            evening: "بعدازظهر (۱۴-۲۲)",
            night: "شب (۲۲-۶)"
        };

        const days = ["یکشنبه", "دوشنبه", "سه شنبه", "چهارشنبه", "پنجشنبه", "جمعه", "شنبه"];
        
        // اطلاعات کاربران مجاز
        const users = {
            'user': { password: 'user123', role: 'user', name: 'کاربر عادی' },
            'admin': { password: 'admin123', role: 'admin', name: 'مدیر سیستم' }
        };

        let currentShift = "morning";
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let personnelList = JSON.parse(localStorage.getItem('personnelList')) || [];
        let currentPositionId = null;
        let currentFurnaceType = null;
        let currentUser = null;
        let hasUnsavedChangesFlag = false;

        // مقداردهی اولیه
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupEventListeners();
        });

        // بررسی وضعیت ورود
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLogin();
            }
        }

        // نمایش برنامه اصلی
        function showMainApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // نمایش اطلاعات کاربر
            document.getElementById('userInfo').textContent = `${currentUser.username} (${currentUser.role === 'admin' ? 'مدیر' : 'کاربر'})`;
            
            // نمایش پنل ادمین فقط برای مدیران
            if (currentUser.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            }
            
            setCurrentDate();
            initializePositions();
            loadSavedData();
            updatePresentPersonnel();
            updatePersonnelTable();
            updatePersonnelDropdown();
        }

        // نمایش صفحه ورود
        function showLogin() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // تنظیم تاریخ و روز جاری
        function setCurrentDate() {
            const today = new Date();
            const day = days[today.getDay()];
            const date = today.toLocaleDateString('fa-IR');
            document.getElementById('current-date').textContent = `${day} - ${date}`;
        }

        // ایجاد لیست پست‌ها
        function initializePositions() {
            const furnace1List = document.getElementById('furnace1Positions');
            const furnace2List = document.getElementById('furnace2Positions');
            
            furnace1List.innerHTML = '';
            furnace2List.innerHTML = '';

            // ایجاد پست‌های کوره شماره ۱
            positions.furnace1.forEach((position) => {
                const positionItem = document.createElement('div');
                positionItem.className = 'list-group-item position-item d-flex justify-content-between align-items-center';
                positionItem.innerHTML = `
                    <div>
                        <h6 class="mb-1">${position.name}</h6>
                        <small class="text-muted" id="info-${position.id}">برای افزودن پرسنل کلیک کنید</small>
                        <div class="personnel-list" id="personnel-list-${position.id}">
                            <!-- لیست پرسنل این پست -->
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary btn-action" data-position-id="${position.id}" data-furnace="1">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                furnace1List.appendChild(positionItem);
            });

            // ایجاد پست‌های کوره شماره ۲
            positions.furnace2.forEach((position) => {
                const positionItem = document.createElement('div');
                positionItem.className = 'list-group-item position-item d-flex justify-content-between align-items-center';
                positionItem.innerHTML = `
                    <div>
                        <h6 class="mb-1">${position.name}</h6>
                        <small class="text-muted" id="info-${position.id}">برای افزودن پرسنل کلیك کنید</small>
                        <div class="personnel-list" id="personnel-list-${position.id}">
                            <!-- لیست پرسنل این پست -->
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary btn-action" data-position-id="${position.id}" data-furnace="2">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                furnace2List.appendChild(positionItem);
            });
        }

        // راه‌اندازی شنودگان رویداد
        function setupEventListeners() {
            // ورود به سیستم
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    showLoginError('لطفاً نام کاربری و رمز عبور را وارد کنید.');
                    return;
                }
                
                // اعتبارسنجی اطلاعات ورود
                if (users[username] && users[username].password === password) {
                    // ورود موفقیت‌آمیز
                    loginSuccess(username, users[username]);
                } else {
                    showLoginError('نام کاربری یا رمز عبور اشتباه است.');
                }
            });
            
            // خروج از سیستم
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (hasUnsavedChangesFlag && !confirm('تغییرات ذخیره نشده‌ای دارید. آیا مطمئن هستید که می‌خواهید خارج شوید؟')) {
                    return;
                }
                
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLogin();
            });

            // تغییر شیفت
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.shift-btn').forEach(b => {
                        b.classList.remove('active');
                        b.classList.remove('btn-primary');
                        b.classList.add('btn-outline-primary');
                    });
                    this.classList.add('active');
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                    currentShift = this.getAttribute('data-shift');
                    loadSavedData();
                    updatePresentPersonnel();
                });
            });

            // دکمه‌های افزودن پرسنل
            document.getElementById('furnace1Positions').addEventListener('click', function(e) {
                if (e.target.closest('.btn-action')) {
                    const positionId = e.target.closest('.btn-action').getAttribute('data-position-id');
                    const furnaceType = e.target.closest('.btn-action').getAttribute('data-furnace');
                    openAttendanceModal(positionId, furnaceType);
                }
                
                // حذف پرسنل
                if (e.target.closest('.btn-delete-personnel')) {
                    const personnelId = e.target.closest('.btn-delete-personnel').getAttribute('data-personnel-id');
                    const positionId = e.target.closest('.btn-delete-personnel').getAttribute('data-position-id');
                    deletePersonnel(positionId, personnelId);
                }
                
                // ویرایش پرسنل
                if (e.target.closest('.btn-edit-personnel')) {
                    const personnelId = e.target.closest('.btn-edit-personnel').getAttribute('data-personnel-id');
                    const positionId = e.target.closest('.btn-edit-personnel').getAttribute('data-position-id');
                    const furnaceType = e.target.closest('.btn-edit-personnel').getAttribute('data-furnace');
                    editPersonnel(positionId, furnaceType, personnelId);
                }
            });

            document.getElementById('furnace2Positions').addEventListener('click', function(e) {
                if (e.target.closest('.btn-action')) {
                    const positionId = e.target.closest('.btn-action').getAttribute('data-position-id');
                    const furnaceType = e.target.closest('.btn-action').getAttribute('data-furnace');
                    openAttendanceModal(positionId, furnaceType);
                }
                
                // حذف پرسنل
                if (e.target.closest('.btn-delete-personnel')) {
                    const personnelId = e.target.closest('.btn-delete-personnel').getAttribute('data-personnel-id');
                    const positionId = e.target.closest('.btn-delete-personnel').getAttribute('data-position-id');
                    deletePersonnel(positionId, personnelId);
                }
                
                // ویرایش پرسنل
                if (e.target.closest('.btn-edit-personnel')) {
                    const personnelId = e.target.closest('.btn-edit-personnel').getAttribute('data-personnel-id');
                    const positionId = e.target.closest('.btn-edit-personnel').getAttribute('data-position-id');
                    const furnaceType = e.target.closest('.btn-edit-personnel').getAttribute('data-furnace');
                    editPersonnel(positionId, furnaceType, personnelId);
                }
            });

            // تغییر وضعیت حضور
            document.querySelectorAll('input[name="status"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleAdditionalSections();
                });
            });

            // ثبت اطلاعات
            document.getElementById('submitAttendance').addEventListener('click', function() {
                submitAttendance(true);
            });

            // افزودن و ادامه
            document.getElementById('addAnotherBtn').addEventListener('click', function() {
                submitAttendance(false);
            });

            // دکمه ذخیره
            document.getElementById('saveBtn').addEventListener('click', function() {
                saveToLocalStorage();
                alert('اطلاعات با موفقیت ذخیره شد.');
                hasUnsavedChangesFlag = false;
            });

            // دکمه گزارش
            document.getElementById('reportBtn').addEventListener('click', function() {
                generateReport();
            });

            // دکمه چاپ
            document.getElementById('printBtn').addEventListener('click', function() {
                window.print();
            });
            
            // دکمه دانلود گزارش
            document.getElementById('downloadBtn').addEventListener('click', function() {
                downloadReport();
            });

            // جستجوی پرسنل
            document.getElementById('personnelSearch').addEventListener('input', function() {
                filterPersonnelTable(this.value);
            });

            // پاک کردن جستجو
            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('personnelSearch').value = '';
                filterPersonnelTable('');
            });

            // افزودن پرسنل جدید
            document.getElementById('addNewPersonnelBtn').addEventListener('click', function() {
                if (currentUser.role !== 'admin') {
                    alert('شما دسترسی لازم برای این عمل را ندارید.');
                    return;
                }
                openPersonnelModal();
            });

            // ذخیره پرسنل
            document.getElementById('savePersonnelBtn').addEventListener('click', function() {
                savePersonnel();
            });

            // تغییر انتخاب پرسنل
            document.getElementById('employeeName').addEventListener('change', function() {
                updateEmployeeIdField();
            });
            
            // هشدار هنگام بستن صفحه
            window.addEventListener('beforeunload', function (e) {
                if (hasUnsavedChanges()) {
                    const message = 'تغییرات ذخیره نشده است. آیا مطمئن هستید که می‌خواهید صفحه را ترک کنید؟';
                    e.returnValue = message;
                    return message;
                }
            });
        }

        // نمایش خطای ورود
        function showLoginError(message) {
            const errorAlert = document.getElementById('loginErrorAlert');
            const errorMessage = document.getElementById('loginErrorMessage');
            
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            
            // مخفی کردن پیغام خطا پس از 5 ثانیه
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // بررسی وجود تغییرات ذخیره نشده
        function hasUnsavedChanges() {
            return hasUnsavedChangesFlag;
        }

        // باز کردن مودال ثبت اطلاعات
        function openAttendanceModal(positionId, furnaceType, editIndex = -1) {
            currentPositionId = positionId;
            currentFurnaceType = furnaceType;
            
            document.getElementById('positionId').value = positionId;
            document.getElementById('furnaceType').value = furnaceType;
            document.getElementById('editIndex').value = editIndex;
            
            const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
            modal.show();

            // اگر در حالت ویرایش هستیم، فرم را پر کنیم
            if (editIndex !== -1) {
                const key = `${currentShift}-${positionId}`;
                if (attendanceData[key] && attendanceData[key][editIndex]) {
                    const personnel = attendanceData[key][editIndex];
                    document.getElementById('employeeName').value = personnel.name || '';
                    document.getElementById('employeeId').value = personnel.employeeId || '';
                    document.querySelector(`input[name="status"][value="${personnel.status || 'present'}"]`).checked = true;
                    document.getElementById('exchangeWith').value = personnel.exchangeWith || '';
                    document.getElementById('notes').value = personnel.notes || '';
                }
            } else {
                document.getElementById('attendanceForm').reset();
            }

            toggleAdditionalSections();
        }

        // تغییر بخش‌های اضافی بر اساس وضعیت
        function toggleAdditionalSections() {
            const status = document.querySelector('input[name="status"]:checked').value;
            const exchangeSection = document.getElementById('exchangeSection');

            if (status === 'exchange') {
                exchangeSection.style.display = 'block';
            } else {
                exchangeSection.style.display = 'none';
            }
        }

        // ثبت اطلاعات حضور و غیاب
        function submitAttendance(closeModal) {
            const positionId = document.getElementById('positionId').value;
            const furnaceType = document.getElementById('furnaceType').value;
            const editIndex = parseInt(document.getElementById('editIndex').value);
            const name = document.getElementById('employeeName').value;
            const employeeId = document.getElementById('employeeId').value;
            const status = document.querySelector('input[name="status"]:checked').value;
            const exchangeWith = document.getElementById('exchangeWith').value;
            const notes = document.getElementById('notes').value;

            if (!name || !employeeId) {
                alert('لطفاً نام و شماره پرسنلی را وارد کنید.');
                return;
            }

            const key = `${currentShift}-${positionId}`;
            
            // پیدا کردن نام پست
            let positionName = "";
            if (furnaceType === "1") {
                const position = positions.furnace1.find(p => p.id == positionId);
                positionName = position ? position.name : "";
            } else {
                const position = positions.furnace2.find(p => p.id == positionId);
                positionName = position ? position.name : "";
            }
            
            // ایجاد یا به روزرسانی آرایه پرسنل برای این پست
            if (!attendanceData[key]) {
                attendanceData[key] = [];
            }
            
            const personnelData = {
                name,
                employeeId,
                status,
                exchangeWith,
                notes,
                position: positionName,
                furnace: furnaceType,
                shift: shifts[currentShift],
                date: new Date().toLocaleDateString('fa-IR')
            };
            
            // اگر در حال ویرایش هستیم
            if (editIndex !== -1) {
                attendanceData[key][editIndex] = personnelData;
            } else {
                // افزودن پرسنل جدید
                attendanceData[key].push(personnelData);
            }
            
            updatePositionInfo(positionId);
            updatePresentPersonnel();
            hasUnsavedChangesFlag = true;
            
            if (closeModal) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('attendanceModal'));
                modal.hide();
            } else {
                // پاک کردن فرم برای افزودن پرسنل بعدی
                document.getElementById('attendanceForm').reset();
                document.getElementById('editIndex').value = -1;
                document.getElementById('exchangeWith').value = '';
            }
        }

        // حذف پرسنل
        function deletePersonnel(positionId, personnelIndex) {
            const key = `${currentShift}-${positionId}`;
            
            if (attendanceData[key] && attendanceData[key][personnelIndex]) {
                if (confirm('آیا از حذف این پرسنل اطمینان دارید؟')) {
                    attendanceData[key].splice(personnelIndex, 1);
                    
                    // اگر هیچ پرسنلی برای این پست وجود ندارد، کلید را حذف کنید
                    if (attendanceData[key].length === 0) {
                        delete attendanceData[key];
                    }
                    
                    updatePositionInfo(positionId);
                    updatePresentPersonnel();
                    saveToLocalStorage();
                    hasUnsavedChangesFlag = true;
                }
            }
        }

        // ویرایش پرسنل
        function editPersonnel(positionId, furnaceType, personnelIndex) {
            openAttendanceModal(positionId, furnaceType, personnelIndex);
        }

        // به‌روزرسانی اطلاعات پست
        function updatePositionInfo(positionId) {
            const infoElement = document.getElementById(`info-${positionId}`);
            const personnelListElement = document.getElementById(`personnel-list-${positionId}`);
            const key = `${currentShift}-${positionId}`;
            
            personnelListElement.innerHTML = '';
            
            if (attendanceData[key] && attendanceData[key].length > 0) {
                infoElement.textContent = `تعداد پرسنل: ${attendanceData[key].length} نفر`;
                
                // نمایش لیست پرسنل
                attendanceData[key].forEach((personnel, index) => {
                    let statusText = '';
                    let badgeClass = '';
                    
                    if (personnel.status === 'present') {
                        statusText = 'انجام وظیفه';
                        badgeClass = 'badge-present';
                    } else if (personnel.status === 'leave') {
                        statusText = 'مرخصی';
                        badgeClass = 'badge-absent';
                    } else if (personnel.status === 'overtime') {
                        statusText = 'اضافه کار';
                        badgeClass = 'badge-overtime';
                    } else if (personnel.status === 'exchange') {
                        statusText = `تعویض با ${personnel.exchangeWith}`;
                        badgeClass = 'badge-exchange';
                    }
                    
                    const personnelItem = document.createElement('div');
                    personnelItem.className = 'personnel-item';
                    personnelItem.innerHTML = `
                        <div class="personnel-info">
                            <div>${personnel.name} (${personnel.employeeId})</div>
                            <small class="text-muted">${statusText}</small>
                        </div>
                        <div class="personnel-actions">
                            <button class="btn btn-sm btn-outline-primary btn-edit-personnel" 
                                    data-position-id="${positionId}" 
                                    data-furnace="${personnel.furnace}" 
                                    data-personnel-id="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-personnel" 
                                    data-position-id="${positionId}" 
                                    data-personnel-id="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    personnelListElement.appendChild(personnelItem);
                });
            } else {
                infoElement.textContent = 'برای افزودن پرسنل کلیک کنید';
            }
        }

        // بارگذاری داده‌های ذخیره شده
        function loadSavedData() {
            // بارگذاری داده‌های کوره ۱
            positions.furnace1.forEach((position) => {
                updatePositionInfo(position.id);
            });

            // بارگذاری داده‌های کوره ۲
            positions.furnace2.forEach((position) => {
                updatePositionInfo(position.id);
            });
        }

        // به‌روزرسانی لیست پرسنل حاضر
        function updatePresentPersonnel() {
            const presentList = document.getElementById('present-personnel-list');
            presentList.innerHTML = '';

            // پرسنل کوره ۱
            positions.furnace1.forEach((position) => {
                const key = `${currentShift}-${position.id}`;
                if (attendanceData[key]) {
                    attendanceData[key].forEach((personnel, index) => {
                        if (personnel.status === 'present' || personnel.status === 'exchange' || personnel.status === 'overtime') {
                            const personnelItem = document.createElement('div');
                            personnelItem.className = 'col-md-6 mb-2';
                            
                            let badgeClass = 'badge-present';
                            if (personnel.status === 'exchange') badgeClass = 'badge-exchange';
                            else if (personnel.status === 'overtime') badgeClass = 'badge-overtime';
                            
                            personnelItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <div>
                                        <strong>${position.name}</strong>
                                        <div>${personnel.name} (${personnel.employeeId})</div>
                                        <small class="text-muted">کوره ۱</small>
                                    </div>
                                    <span class="badge ${badgeClass}">${personnel.status === 'exchange' ? 'تعویض' : personnel.status === 'overtime' ? 'اضافه کار' : 'حاضر'}</span>
                                </div>
                            `;
                            presentList.appendChild(personnelItem);
                        }
                    });
                }
            });

            // پرسنل کوره ۲
            positions.furnace2.forEach((position) => {
                const key = `${currentShift}-${position.id}`;
                if (attendanceData[key]) {
                    attendanceData[key].forEach((personnel, index) => {
                        if (personnel.status === 'present' || personnel.status === 'exchange' || personnel.status === 'overtime') {
                            const personnelItem = document.createElement('div');
                            personnelItem.className = 'col-md-6 mb-2';
                            
                            let badgeClass = 'badge-present';
                            if (personnel.status === 'exchange') badgeClass = 'badge-exchange';
                            else if (personnel.status === 'overtime') badgeClass = 'badge-overtime';
                            
                            personnelItem.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <div>
                                        <strong>${position.name}</strong>
                                        <div>${personnel.name} (${personnel.employeeId})</div>
                                        <small class="text-muted">کوره ۲</small>
                                    </div>
                                    <span class="badge ${badgeClass}">${personnel.status === 'exchange' ? 'تعویض' : personnel.status === 'overtime' ? 'اضافه کار' : 'حاضر'}</span>
                                </div>
                            `;
                            presentList.appendChild(personnelItem);
                        }
                    });
                }
            });
        }

        // ذخیره در localStorage
        function saveToLocalStorage() {
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('personnelList', JSON.stringify(personnelList));
        }

        // تولید گزارش
        function generateReport() {
            let reportContent = "گزارش حضور و غیاب\n";
            reportContent += "==============================\n\n";
            
            reportContent += `تاریخ: ${new Date().toLocaleDateString('fa-IR')}\n`;
            reportContent += `شیفت: ${shifts[currentShift]}\n`;
            reportContent += "==============================\n\n";
            
            // اطلاعات کوره ۱
            reportContent += "کوره شماره ۱:\n";
            reportContent += "------------------------------\n";
            
            positions.furnace1.forEach((position) => {
                const key = `${currentShift}-${position.id}`;
                reportContent += `\n${position.name}:\n`;
                
                if (attendanceData[key]) {
                    attendanceData[key].forEach((personnel, index) => {
                        let statusText = '';
                        
                        if (personnel.status === 'present') {
                            statusText = `انجام وظیفه: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'leave') {
                            statusText = `مرخصی: ${personnel.name}`;
                        } else if (personnel.status === 'overtime') {
                            statusText = `اضافه کار: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'exchange') {
                            statusText = `تعویض: ${personnel.name} (${personnel.employeeId}) با ${personnel.exchangeWith}`;
                        }
                        
                        if (personnel.notes) {
                            statusText += ` - توضیحات: ${personnel.notes}`;
                        }
                        
                        reportContent += `${statusText}\n`;
                    });
                } else {
                    reportContent += "ثبت نشده\n";
                }
            });
            
            reportContent += "\n\nکوره شماره ۲:\n";
            reportContent += "------------------------------\n";
            
            // اطلاعات کوره ۲
            positions.furnace2.forEach((position) => {
                const key = `${currentShift}-${position.id}`;
                reportContent += `\n${position.name}:\n`;
                
                if (attendanceData[key]) {
                    attendanceData[key].forEach((personnel, index) => {
                        let statusText = '';
                        
                        if (personnel.status === 'present') {
                            statusText = `انجام وظیفه: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'leave') {
                            statusText = `مرخصی: ${personnel.name}`;
                        } else if (personnel.status === 'overtime') {
                            statusText = `اضافه کار: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'exchange') {
                            statusText = `تعویض: ${personnel.name} (${personnel.employeeId}) با ${personnel.exchangeWith}`;
                        }
                        
                        if (personnel.notes) {
                            statusText += ` - توضیحات: ${personnel.notes}`;
                        }
                        
                        reportContent += `${statusText}\n`;
                    });
                } else {
                    reportContent += "ثبت نشده\n";
                }
            });
            
            // نمایش گزارش در alert
            alert(reportContent);
        }
        
        // دانلود گزارش
        function downloadReport() {
            const reportContent = generateReportForDownload();
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `گزارش-حضور-و-غیاب-${new Date().toLocaleDateString('fa-IR')}.txt`;
            a.click();
        }
        
        // تولید گزارش برای دانلود
        function generateReportForDownload() {
            let reportContent = "گزارش حضور و غیاب\n";
            reportContent += "==============================\n\n";
            
            reportContent += `تاریخ: ${new Date().toLocaleDateString('fa-IR')}\n`;
            reportContent += `شیفت: ${shifts[currentShift]}\n`;
            reportContent += "==============================\n\n";
            
            // اطلاعات کوره ۱
            reportContent += "کوره شماره ۱:\n";
            reportContent += "------------------------------\n";
            
            positions.furnace1.forEach((position) => {
                const key = `${currentShift}-${position.id}`;
                reportContent += `\n${position.name}:\n`;
                
                if (attendanceData[key]) {
                    attendanceData[key].forEach((personnel, index) => {
                        let statusText = '';
                        
                        if (personnel.status === 'present') {
                            statusText = `انجام وظیفه: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'leave') {
                            statusText = `مرخصی: ${personnel.name}`;
                        } else if (personnel.status === 'overtime') {
                            statusText = `اضافه کار: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'exchange') {
                            statusText = `تعویض: ${personnel.name} (${personnel.employeeId}) با ${personnel.exchangeWith}`;
                        }
                        
                        if (personnel.notes) {
                            statusText += ` - توضیحات: ${personnel.notes}`;
                        }
                        
                        reportContent += `${statusText}\n`;
                    });
                } else {
                    reportContent += "ثبت نشده\n";
                }
            });
            
            reportContent += "\n\nکوره شماره ۲:\n";
            reportContent += "------------------------------\n";
            
            // اطلاعات کوره ۲
            positions.furnace2.forEach((position) => {
                const key = `${currentShift}-${position.id}`;
                reportContent += `\n${position.name}:\n`;
                
                if (attendanceData[key]) {
                    attendanceData[key].forEach((personnel, index) => {
                        let statusText = '';
                        
                        if (personnel.status === 'present') {
                            statusText = `انجام وظیفه: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'leave') {
                            statusText = `مرخصی: ${personnel.name}`;
                        } else if (personnel.status === 'overtime') {
                            statusText = `اضافه کار: ${personnel.name} (${personnel.employeeId})`;
                        } else if (personnel.status === 'exchange') {
                            statusText = `تعویض: ${personnel.name} (${personnel.employeeId}) با ${personnel.exchangeWith}`;
                        }
                        
                        if (personnel.notes) {
                            statusText += ` - توضیحات: ${personnel.notes`;
                        }
                        
                        reportContent += `${statusText}\n`;
                    });
                } else {
                    reportContent += "ثبت نشده\n";
                }
            });
            
            return reportContent;
        }

        // به‌روزرسانی جدول پرسنل
        function updatePersonnelTable() {
            const tableBody = document.getElementById('personnelTableBody');
            tableBody.innerHTML = '';
            
            if (personnelList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center">هیچ پرسنلی ثبت نشده است</td></tr>';
                return;
            }
            
            personnelList.forEach((personnel, index) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${personnel.name}</td>
                    <td>${personnel.id}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-personnel" data-index="${index}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-personnel" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // اضافه کردن event listener برای دکمه‌های ویرایش و حذف
            document.querySelectorAll('.edit-personnel').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (currentUser.role !== 'admin') {
                        alert('شما دسترسی لازم برای این عمل را ندارید.');
                        return;
                    }
                    const index = this.getAttribute('data-index');
                    openPersonnelModal(index);
                });
            });
            
            document.querySelectorAll('.delete-personnel').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (currentUser.role !== 'admin') {
                        alert('شما دسترسی لازم برای این عمل را ندارید.');
                        return;
                    }
                    const index = this.getAttribute('data-index');
                    deletePersonnelFromList(index);
                });
            });
        }

        // فیلتر کردن جدول پرسنل
        function filterPersonnelTable(searchTerm) {
            const rows = document.querySelectorAll('#personnelTableBody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('td:first-child').textContent.toLowerCase();
                const id = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                
                if (name.includes(searchTerm.toLowerCase()) || id.includes(searchTerm.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // باز کردن مودال مدیریت پرسنل
        function openPersonnelModal(index = -1) {
            const modal = new bootstrap.Modal(document.getElementById('personnelModal'));
            const title = document.getElementById('personnelModalTitle');
            const form = document.getElementById('personnelForm');
            
            if (index === -1) {
                // حالت افزودن جدید
                title.textContent = 'افزودن پرسنل جدید';
                form.reset();
                document.getElementById('personnelEditId').value = '';
            } else {
                // حالت ویرایش
                title.textContent = 'ویرایش پرسنل';
                const personnel = personnelList[index];
                document.getElementById('newEmployeeName').value = personnel.name;
                document.getElementById('newEmployeeId').value = personnel.id;
                document.getElementById('personnelEditId').value = index;
            }
            
            modal.show();
        }

        // ذخیره پرسنل
        function savePersonnel() {
            const name = document.getElementById('newEmployeeName').value;
            const id = document.getElementById('newEmployeeId').value;
            const editIndex = document.getElementById('personnelEditId').value;
            
            if (!name || !id) {
                alert('لطفاً نام و شماره پرسنلی را وارد کنید.');
                return;
            }
            
            if (!/^\d+$/.test(id)) {
                alert('شماره پرسنلی باید فقط شامل عدد باشد.');
                return;
            }
            
            // بررسی تکراری نبودن شماره پرسنلی
            if (editIndex === '' && personnelList.some(p => p.id === id)) {
                alert('این شماره پرسنلی قبلاً ثبت شده است.');
                return;
            }
            
            if (editIndex === '') {
                // افزودن جدید
                personnelList.push({ name, id });
            } else {
                // ویرایش
                personnelList[editIndex] = { name, id };
            }
            
            saveToLocalStorage();
            updatePersonnelTable();
            updatePersonnelDropdown();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('personnelModal'));
            modal.hide();
            alert('اطلاعات پرسنل با موفقیت ذخیره شد.');
        }

        // حذف پرسنل از لیست
        function deletePersonnelFromList(index) {
            if (confirm('آیا از حذف این پرسنل اطمینان دارید؟')) {
                personnelList.splice(index, 1);
                saveToLocalStorage();
                updatePersonnelTable();
                updatePersonnelDropdown();
                alert('پرسنل با موفقیت حذف شد.');
            }
        }

        // به‌روزرسانی dropdown پرسنل
        function updatePersonnelDropdown() {
            const dropdown = document.getElementById('employeeName');
            dropdown.innerHTML = '<option value="">انتخاب پرسنل</option>';
            
            personnelList.forEach(personnel => {
                const option = document.createElement('option');
                option.value = personnel.name;
                option.textContent = `${personnel.name} (${personnel.id})`;
                option.setAttribute('data-id', personnel.id);
                dropdown.appendChild(option);
            });
        }

        // به‌روزرسانی فیلد شماره پرسنلی بر اساس انتخاب
        function updateEmployeeIdField() {
            const selectedOption = document.getElementById('employeeName').selectedOptions[0];
            if (selectedOption && selectedOption.getAttribute('data-id')) {
                document.getElementById('employeeId').value = selectedOption.getAttribute('data-id');
            } else {
                document.getElementById('employeeId').value = '';
            }
        }

        // ورود موفقیت‌آمیز
        function loginSuccess(username, userData) {
            // نمایش پیام موفقیت
            const errorAlert = document.getElementById('loginErrorAlert');
            const errorMessage = document.getElementById('loginErrorMessage');
            
            errorAlert.className = 'login-alert alert-success';
            errorMessage.innerHTML = `<i class="fas fa-check-circle me-2"></i> ورود موفق! در حال انتقال به سیستم...`;
            errorAlert.style.display = 'block';
            
            // غیرفعال کردن دکمه ورود
            const loginBtn = document.querySelector('.btn-login');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال انتقال...';
            
            // ذخیره اطلاعات کاربر در localStorage
            currentUser = {
                username: username,
                role: userData.role,
                name: userData.name
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // انتقال به صفحه اصلی پس از 2 ثانیه
            setTimeout(() => {
                showMainApp();
            }, 2000);
        }
    </script>
</body>
</html>
